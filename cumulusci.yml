# Minimum required version of CumulusCI to run this project
minimum_cumulusci_version: "4.0.0"

#-------------------------#
# SCRATCH ORG DEFINITIONS #
#-------------------------#
# These are the different scratch org configurations available for development
# Each org has its own configuration file in the orgs/ directory and a specified duration
# The days parameter determines how long the scratch org will remain active

orgs:
  scratch:
    beta:
      config_file: orgs/beta.json
      days: 30
    dev-sb0:
      config_file: orgs/dev-sb0.json
      days: 30
    test-sb0:
      config_file: orgs/test-sb0.json
      days: 30
    tfid:
      config_file: orgs/tfid.json
      days: 30
    tfid-cdo:
      config_file: orgs/tfid-cdo.json
      days: 30
    tfid-cdo-rlm:
      config_file: orgs/tfid-cdo-rlm.json
      days: 30
    tfid-ido-tech:
      config_file: orgs/tfid-ido-tech-SB0.json
      days: 30
    tfid-ido-tech-R2:
      config_file: orgs/tfid-ido-tech-R2.json
      days: 30
    tfid-qb-tso:
      config_file: orgs/tfid-qb-tso.json
      days: 30
    tfid-sdo:
      config_file: orgs/tfid-sdo.json
      days: 30
    tfid-dev:
      config_file: orgs/tfid-dev.json
      days: 30
    tfid-enable:
      config_file: orgs/tfid-enable.json
      days: 30
    dev_preview:
      config_file: orgs/dev_preview.json
      days: 30
    dev_previous:
      config_file: orgs/dev_previous.json
      days: 30
    dev_datacloud:
      config_file: orgs/dev_datacloud.json
      days: 30
    dev:
      config_file: orgs/dev.json
      days: 30
    dev_enhanced:
      config_file: orgs/dev-enhanced.json
      days: 30

# Project configuration settings
# Defines the project name, package details, and source format
project:
  name: rlm-base
  package:
    name: rlm-base
    api_version: "66.0"
  git:
    default_branch: "main"
  source_format: sfdx

#-----------------#
# CUSTOM SETTINGS #
#-----------------#
# These custom settings control feature flags and configuration options
# They are used throughout the deployment process to conditionally execute tasks
# Each setting can be toggled on/off to enable/disable specific features

  custom:
    qbrix: false               # Use xDO base (false for dev scratch orgs without xDO licenses)
    tso: false                 # Is Trialforce Source Org? (false for dev scratch orgs)
    qb: true                  # Is QuantumBit?
    q3: false                 # Include Q3 data
    calmdelete: true          # Use CALM Delete
    tax: true                 # Use Tax engine
    billing: true             # Use Billing
    payments: true            # Use Payments
    approvals: true           # Use Approvals
    clm: true                # Use Contract Lifecycle Management
    clm_data: false           # Use Contract Lifecycle Management Data
    dro: true                 # Use Dynamic Revenue Orchestration
    rating: true              # Insert Rating Design Time Data
    rates: true               # Insert Rates
    ramps: true               # Insert and configure ramps
    einstein: true            # Use Einstein AI
    product_dataset: qb       # Default product dataset to use=
    agents: false             # Deploy Agentforce Agent Configurations
    refresh: false            # Data refresh flag
    prm: true                # Use Partner Relationship Management
    prm_exp_bundle: false     # Use PRM Experience Bundle
    commerce: false           # Use Commerce
    quantumbit: true          # Use QuantumBit
    breconfig: false          # Business Rules Engine configuration
    docgen: true              # Use Document Generation
    constraints: true         # Use Constraint Builder
    constraints_data: true   # Use Constraint Builder Data
    guidedselling: false      # Use Guided Selling
    procedureplans: true     # Use Procedure Plans
    sharingsettings: false    # Deploy Sharing Settings
    visualization: false      # Use Visualization components (Flow with Visuals, LWC styling)
    locale: en_US             # Default locale

#------------------------------#
# PERMISSION SETS AND LICENSES #
#------------------------------#
# These sections define the permission sets and licenses that will be assigned
# based on the target org type and available features
# Each section is defined as a YAML anchor (&) for reuse throughout the file

    rlm_psl_api_names: &rlm_psl_api_names
      # Core RLM permission set licenses
      - BREDesigner
      - BRERuntime
      - CorePricingDesignTime
      - DataProcessingEnginePsl
      - DecimalQuantityDesigntimePsl
      - DecimalQuantityRuntimePsl
      - DocGenDesignerPsl
      - DocumentBuilderUserPsl
      - DynamicRevenueOrchestratorUserPsl
      - IndustriesConfiguratorPsl
      - Microsoft365WordPsl
      - OmniStudioDesigner
      - ProductCatalogManagementAdministratorPsl
      - ProductDiscoveryUserPsl
      - RatingDesignTimePsl
      - RatingRunTimePsl
      - RevenueLifecycleManagementUserPsl
      - RevLifecycleMgmtBillingPsl
      - UsageDesignTimePsl
      - UsageRunTimePsl
      - WalletManagementUserPsl
      - BillingAdvancedPsl
      - IndustriesARCPsl
      - CollectionsAndRecoveryPsl
      - RevPromotionsManagementPsl

    rlm_ai_psg_api_names: &rlm_ai_psg_api_names
      # AI-related permission set groups
      - CopilotSalesforceUserPSG
      - CopilotSalesforceAdminPSG

    rlm_ai_psl_api_names: &rlm_ai_psl_api_names
      # AI-related permission set licenses
      # Note: Some PSLs removed for dev scratch org compatibility
      - AgentforceServiceAgentBuilderPsl
      # - AIAcceleratorPsl  # Not available in Enterprise dev scratch orgs
      # - EinsteinAnalyticsPlusPsl  # Not available in Enterprise dev scratch orgs
      # - EinsteinDisclsAndCmplHubUserPsl  # Not available in Enterprise dev scratch orgs
      - EinsteinGPTCopilotPsl
      - EinsteinGPTPromptTemplatesPsl
      # - MySearchPsl  # Not available in Enterprise dev scratch orgs
      # - RevenueIntelligencePsl  # Not available in Enterprise dev scratch orgs
      # - ScoringFrameworkPsl  # Not available in Enterprise dev scratch orgs (moved to core list if needed)

    rlm_tableaunext_psl_api_names: &rlm_tableaunext_psl_api_names
      # Tableau-related permission set licenses
      - TableauEinsteinUserPsl

    rlm_tableaunext_ps_api_names: &rlm_tableaunext_ps_api_names
      # Tableau-related permission sets
      - TableauEinsteinAdmin
      - TableauEinsteinBusinessUser
      - TableauEinsteinAnalyst
      - TableauSelfServiceAnalyst

    rlm_ai_ps_api_names: &rlm_ai_ps_api_names
      # AI-related permission sets
      - EinsteinGPTPromptTemplateManager
      - SalesCloudEinsteinAll

    rlm_tso_psl_api_names: &rlm_tso_psl_api_names
      # Trialforce Source Org permission set licenses
      - AutomatedActionsPsl
      - EinsteinAgentCWUPsl
      - EinsteinAgentPsl
      - EinsteinCopilotReviewMyDayPsl
      - EinsteinDiscoveryInTableauPsl
      - EinsteinGPTCallExplorerPsl
      - EinsteinGPTCreateClosePlanPsl
      - EinsteinGPTGetProductPricingPsl
      - EinsteinGPTGroundingStructuredDataPsl
      - EinsteinGPTMeetingFollowUpPsl
      - EinsteinGPTSalesCallSummariesPsl
      - EinsteinGPTSalesEmailsPsl
      - EinsteinGPTSalesMiningPsl
      - EinsteinGPTSalesSummariesPsl
      - EinsteinGPTSendMeetingRequestPsl
      - EinsteinSalesGenerativeInsightsPsl
      - EinsteinSalesRepFeedbackPsl
      - ERIPlatformBasic
      - SalesActionFindPastCollaboratorsPsl
      - SalesActionReviewBuyingCommitteePsl
      - SalesCloudUnlimitedAnalyticsAdminPsl
      - SalesCloudUnlimitedPsl
      - SalesEngagementBasicPsl

    rlm_tso_psg_api_names: &rlm_tso_psg_api_names
      # Territory Sales Operations permission set groups
      - CopilotSalesforceUserPSG
      - CopilotSalesforceAdminPSG
      - UnifiedCatalogAdminPsl
      - UnifiedCatalogDesignerPsl

    rlm_tso_ps_api_names: &rlm_tso_ps_api_names
      # Territory Sales Operations permission sets
      - ERIBasic
      - RC_Utilities
      - OrchestrationProcessManagerPermissionSet
      - EventMonitoringPermSet
  
    rlm_pcm_ps_api_names: &rlm_pcm_ps_api_names
      # Product Catalog Management permission sets
      - IndustriesConfiguratorPlatformApi
      - ProductConfigurationRulesDesigner
      - ProductCatalogManagementAdministrator
      - ProductCatalogManagementViewer

    rlm_blng_ps_api_names: &rlm_blng_ps_api_names
      # Billing-related permission sets
      - AnalyticsStoreUser
      - RevenueLifecycleManagementAccountingAdmin
      - RevenueLifecycleManagementBillingAdmin
      - RevenueLifecycleManagementBillingCreateInvoiceFromBillingScheduleApi
      - RevenueLifecycleManagementBillingCreditMemoOperations
      - RevenueLifecycleManagementBillingInvoiceErrorRecoveryApi
      - RevenueLifecycleManagementBillingOperations
      - RevenueLifecycleManagementBillingTaxAdmin
      - RevenueLifecycleManagementBillingVoidPostedInvoiceApi
      - RevenueLifecycleManagementCreateBillingScheduleFromBillingTransactionApi

    rlm_clm_psl_api_names: &rlm_clm_psl_api_names
      # Contract Lifecycle Management permission set licenses
      - ClauseManagementUser
      - CLMAnalyticsPsl
      - ContractManagementUser
      #- ContractsAIUserPsl
      - DisclosureAndComplianceHubUserPsl
      - DocGenDesignerPsl
      - DocumentBuilderUserPsl
      - InsightsCGAnalyticsPsl
      - Microsoft365WordPsl
      - NLPServicePsl
      - ObligationManagementUser
      - OmniStudioDesigner
      - ScoringFrameworkPsl

    rlm_psg_api_names: &rlm_psg_api_names
      # Core permission set groups
      - RC_QB_AI
      - RC_RCB
      - RC_RMI
      - RLM_CFG
      - RLM_CLM
      - RLM_DOC
      - RLM_DRO
      - RLM_NGP
      - RLM_PCM
      - RLM_PSL
      - RLM_USG

    psg_tso: &psg_tso
      - RC_TSO
      
    ps_quantumbit: &ps_quantumbit
      # QuantumBit-specific permission sets
      - RLM_QuantumBit
      #- RC_Collection_Plan_Activity

    ps_calmdelete: &ps_calmdelete
      # CALM Delete-specific permission sets
      - RLM_CALM_SObject_Access

    ps_aea: &ps_aea
      # Agent-specific permission sets
      - RLM_Revenue_Cloud_Agent


    ps_constraints: &ps_constraints
      # Constraints-specific permission sets
      - RLM_Constraints

#-----------------#
# DECISION TABLES #
#-----------------#
# These sections define the decision tables that need to be refreshed during deployment
# Each section is defined as a YAML anchor (&) for reuse throughout the file
# Decision tables are used for business logic and rule processing

    dt_rating_decision_tables: &dt_rating_decision_tables
      # Core rating decision tables for asset and binding object rate calculations
      - Asset_Action_Source_Entries_Decision_Table_V2
      - Asset_Rate_Card_Entry_Resolution_V2
      - Asset_Rate_Card_Entry_Resolution_Entries
      - Asset_Rate_Decision_Table_V2
      - Asset_Rate_Adjustment_Resolution_Entries
      - Asset_Tier_based_Rate_Adjustment_V2
      - Asset_Volume_based_Rate_Adjustment_V2
      - Attribute_based_Rate_Adjustment_by_Rate_Card_Entry_ID
      - Binding_Object_Rate_Card_Entry_Resolution_V2
      - Binding_Object_Rate_Card_Entry_Resolution_Entries_v2
      - Binding_Object_Rate_Decision_Table_V2
      - Binding_Object_Rate_Adjustment_Resolution_Entries
      - Binding_Object_Tier_based_Rate_Adjustment_V2
      - Binding_Object_Volume_based_Rate_Adjustment_V2
      - Commitment_based_Rate_Adjustment
      - Rate_Adjustment_by_Attribute_Entries_2
      - Rate_Adjustment_by_Tier_Entries_2
      - Rate_Adjustment_by_Volume_Entries_2
      - Rate_Card_Entries_2
      - Tier_based_Rate_Adjustment_by_Rate_Card_Entry_ID
      - Volume_based_Rate_Adjustment_by_Rate_Card_Entry_ID
      - Index_Rate_Decision_Table

    dt_rating_discovery_decision_tables: &dt_rating_discovery_decision_tables
      # Decision tables used for rating discovery and resolution
      - Binding_Object_Rate_Adjustment_Resolution_Entries
      - Binding_Object_Rate_Card_Entry_Resolution_Entries_v2
      - Pricebook_Rate_Card_Decision_Table
      - Rate_Adjustment_by_Attribute_Resolution_Decision_Table
      - Rate_Adjustment_by_Tier_Resolution_Decision_Table
      - Rate_Card_Entry_Resolution_Entries_2

    dt_default_pricing_decision_tables: &dt_default_pricing_decision_tables
      # Default pricing decision tables for contract and price adjustments
      # UsageType in org: DefaultPricing (StandardTax: RevenueStandardTax)
      - Attribute_Based_Adjustment_Decision_Table
      - Bundle_Based_Adjustment_Decision_Table
      - Contract_Pricing_Adjustment_Tiers
      - Contract_Pricing_Entries_Decision_Table
      - Contract_Pricing_Volume_Tiers
      - Price_Adjustment_Tier_Decision_Table
      - Price_Book_Entry_Decision_Table_v2
      - Tiered_Adjustment_Tier_Decision_Table
      - StandardTax

    dt_asset_decision_tables: &dt_asset_decision_tables
      # Asset-specific decision tables for rate calculations and adjustments
      - Asset_Action_Source_Entries_Decision_Table_V2
      - Asset_Rate_Card_Entry_Resolution_V2
      - Asset_Rate_Decision_Table_V2
      - Asset_Tier_based_Rate_Adjustment_V2
      - Asset_Volume_based_Rate_Adjustment_V2
      - Asset_Rate_Adjustment_Resolution_Entries
      - Asset_Rate_Card_Entry_Resolution_Entries
      - Commitment_based_Rate_Adjustment

    dt_pricing_discovery_decision_tables: &dt_pricing_discovery_decision_tables
      # Decision tables used for pricing discovery and derived pricing
      - Asset_Action_Source_Entries_Decision_Table_V2
      - Derived_Pricing_Entries_Decision_Table

    dt_activation_decision_tables: &dt_activation_decision_tables
      # Decision tables to enforce as Active during org preparation
      - RLM_ProductCategoryQualification
      - RLM_ProductQualification
      - RLM_CostBookEntries

    dt_commerce_decision_tables: &dt_commerce_decision_tables
      # Commerce decision tables (refresh when project__custom__commerce is true)
      # UsageType in org: DefaultPricing
      - Price_Book_Entry_Commerce_V2
      - Price_Book_Entry_For_Unit_Price_Commerce_V1
      - Pricebook_Entry_Adjustment_Commerce_V1
      - Range_Based_Adjustments_Commerce_V1
      - Slab_Based_Adjustments_Commerce_V1

#-----------------------------#
# CONTEXT DEFINITION SETTINGS #
#-----------------------------#
# These sections define the context definitions used in the deployment process
# Each context has a name, default mapping, and base reference
# Contexts are used to manage data relationships and business logic

    default_context_start_date: &default_context_start_date "2020-01-01T00:00:00.000Z"
    default_context_ttl: &default_context_ttl 30

    asset_context_name: &asset_context_name RLM_AssetContext
    asset_context_default_mapping: &asset_context_default_mapping AssetEntitiesMapping
    asset_context_base_reference: &asset_context_base_reference AssetContext__stdctx

    sales_transaction_context_name: &sales_transaction_context_name RLM_SalesTransactionContext
    sales_transaction_context_default_mapping: &sales_transaction_context_default_mapping QuoteEntitiesMapping
    sales_transaction_context_base_reference: &sales_transaction_context_base_reference SalesTransactionContext__stdctx

    product_discovery_context_name: &product_discovery_context_name RLM_ProductDiscoveryContext
    product_discovery_context_default_mapping: &product_discovery_context_default_mapping ProductDiscoveryMapping
    product_discovery_context_base_reference: &product_discovery_context_base_reference ProductDiscoveryContext__stdctx

    cart_context_name: &cart_context_name RLM_CommerceCartContext
    cart_context_default_mapping: &cart_context_default_mapping CommerceCartMapping
    cart_context_base_reference: &cart_context_base_reference CommerceCartContextDefinition__stdctx

    billing_context_name: &billing_context_name RLM_BillingContext
    billing_context_default_mapping: &billing_context_default_mapping BSGEntitiesMapping
    billing_context_base_reference: &billing_context_base_reference BillingContext__stdctx
    billing_default_treatment_name: &billing_default_treatment_name "Billing Treatment - USA - Advance"
    billing_default_legal_entity_name: &billing_default_legal_entity_name "Default Legal Entity - US"
    billing_default_tax_treatment_name: &billing_default_tax_treatment_name "Default Tax Policy"

    fulfillment_asset_context_name: &fulfillment_asset_context_name RLM_FulfillmentAssetContext
    fulfillment_asset_context_default_mapping: &fulfillment_asset_context_default_mapping FulfillAssetEntitiesMapping
    fulfillment_asset_context_base_reference: &fulfillment_asset_context_base_reference FulfillmentAssetContext__stdctx

    contracts_context_name: &contracts_context_name RLM_ContractsContext
    contracts_context_default_mapping: &contracts_context_default_mapping OppToCntrPersistenceMapping
    contracts_context_base_reference: &contracts_context_base_reference ContractsContextDefinition__stdctx

    contracts_extraction_context_name: &contracts_extraction_context_name RLM_ContractsExtractionContext
    contracts_extraction_context_default_mapping: &contracts_extraction_context_default_mapping DocExtrctPersistenceMapping
    contracts_extraction_context_base_reference: &contracts_extraction_context_base_reference ContractsExtractionContext__stdctx

    collection_plan_segment_context_name: &collection_plan_segment_context_name RLM_CollectionPlanSegmentCtx
    collection_plan_segment_context_default_mapping: &collection_plan_segment_context_default_mapping CollectionPlanContextMapping
    collection_plan_segment_context_base_reference: &collection_plan_segment_context_base_reference CollectionPlanSegmentContext__stdctx

    rate_management_context_name: &rate_management_context_name RLM_RateManagementContext
    rate_management_context_default_mapping: &rate_management_context_default_mapping DefaultUsageMapping
    rate_management_context_base_reference: &rate_management_context_base_reference RateManagementContext__stdctx

    rating_discovery_context_name: &rating_discovery_context_name RLM_RatingDiscoveryContext
    rating_discovery_context_default_mapping: &rating_discovery_context_default_mapping CatalogMapping
    rating_discovery_context_base_reference: &rating_discovery_context_base_reference RatingDiscoveryContext__stdctx


#------------------------------------#
# PROCEDURE PLAN DEFINITION SETTINGS #
#------------------------------------#
# These anchors define the settings for the procedure plan definition
# Each setting is referenced in the create_procedure_plan_definition task

    procedure_plan_definition_description: &procedure_plan_definition_description "Procedure Plan Definition for Quote Pricing"
    procedure_plan_definition_developer_name: &procedure_plan_definition_developer_name "RC_Quote_Pricing_Procedure_Plan"
    procedure_plan_definition_name: &procedure_plan_definition_name "RC_Quote_Pricing_Procedure_Plan"
    procedure_plan_definition_primary_object: &procedure_plan_definition_primary_object "Quote"
    procedure_plan_definition_process_type: &procedure_plan_definition_process_type "RevenueCloud"
    procedure_plan_definition_version_active: &procedure_plan_definition_version_active false
    context_definition_label: &context_definition_label "RLM_SalesTransactionContext"
    procedure_plan_definition_version_read_context_mapping: &procedure_plan_definition_version_read_context_mapping "QuoteEntitiesMapping"
    procedure_plan_definition_version_save_context_mapping: &procedure_plan_definition_version_save_context_mapping "QuoteEntitiesMapping"
    procedure_plan_definition_version_effective_from: &procedure_plan_definition_version_effective_from "2026-01-01T00:00:00.000Z"
    procedure_plan_definition_version_developer_name: &procedure_plan_definition_version_developer_name "RC_Quote_Pricing_Procedure_Plan"
    procedure_plan_definition_version_rank: &procedure_plan_definition_version_rank 1
    procedure_plan_definition_version_effective_to: &procedure_plan_definition_version_effective_to 

#------------------------------------#
# DATA PLAN NAMES AND PATHS SETTINGS #
#------------------------------------#
# These anchors define the paths to various datasets used for data loading tasks
# Each dataset is referenced in the data load tasks to insert or update data in the org
# The datasets are organized by feature (QuantumBit, Q3, etc.) and data type (product, billing, etc.)

    quantumbit_product_dataset: &quantumbit_product_dataset "datasets/sfdmu/qb/en-US/qb-pcm"               # QuantumBit product data
    quantumbit_pricing_dataset: &quantumbit_pricing_dataset "datasets/sfdmu/qb/en-US/qb-pricing"               # QuantumBit product data
    quantumbit_product_image_dataset: &quantumbit_product_image_dataset "datasets/sfdmu/qb/en-US/qb-product-images"  # QuantumBit product image data
    quantumbit_billing_dataset: &quantumbit_billing_dataset "datasets/sfdmu/qb/en-US/qb-billing"                     # QuantumBit billing data
    quantumbit_dro_dataset: &quantumbit_dro_dataset "datasets/sfdmu/qb/en-US/qb-dro"                                 # QuantumBit DRO data (dynamic AssignedTo from target org)
    quantumbit_tax_dataset: &quantumbit_tax_dataset "datasets/sfdmu/qb/en-US/qb-tax"                                 # QuantumBit tax data
    quantumbit_rating_dataset: &quantumbit_rating_dataset "datasets/sfdmu/qb/en-US/qb-rating"                    # QuantumBit rating data
    quantumbit_rates_dataset: &quantumbit_rates_dataset "datasets/sfdmu/qb/en-US/qb-rates"                           # QuantumBit rates data
    quantumbit_constraints_product_dataset: &quantumbit_constraints_product_dataset "datasets/sfdmu/qb/en-US/qb-constraints-product"   # DEPRECATED - replaced by CML import
    quantumbit_constraints_component_dataset: &quantumbit_constraints_component_dataset "datasets/sfdmu/qb/en-US/qb-constraints-component" # DEPRECATED - replaced by CML import
    quantumbit_constraints_data_dir: &quantumbit_constraints_data_dir "datasets/constraints/qb/QuantumBitComplete"  # CML constraint model data (CSVs + blob)
    server2_constraints_data_dir: &server2_constraints_data_dir "datasets/constraints/qb/Server2"  # Server2 CML constraint model data (CSVs + blob)
    quantumbit_transactionprocessingtypes_dataset: &quantumbit_transactionprocessingtypes_dataset "datasets/sfdmu/qb/en-US/qb-transactionprocessingtypes" # QuantumBit transaction processing types
    quantumbit_guidedselling_dataset: &quantumbit_guidedselling_dataset "datasets/sfdmu/qb/en-US/qb-guidedselling"   # QuantumBit guided selling data
    quantumbit_clm_dataset: &quantumbit_clm_dataset "datasets/sfdmu/qb/en-US/qb-clm"                                 # QuantumBit CLM data

    procedure_plans_dataset: &procedure_plans_dataset "datasets/sfdmu/procedure-plans"                                 # Procedure Plan data (sections + options)

    q3_product_dataset: &q3_product_dataset "datasets/sfdmu/q3/en-US/q3-multicurrency"                               # Q3 product data
    q3_billing_dataset: &q3_billing_dataset "datasets/sfdmu/q3/en-US/q3-billing"                                     # Q3 billing data
    q3_dro_dataset: &q3_dro_dataset "datasets/sfdmu/q3/en-US/q3-dro"                                                 # Q3 DRO data
    q3_tax_dataset: &q3_tax_dataset "datasets/sfdmu/q3/en-US/q3-tax"                                                 # Q3 tax data
    q3_rating_dataset: &q3_rating_dataset "datasets/sfdmu/q3/en-US/q3-rating"                                    # Q3 rating data
    q3_rates_dataset: &q3_rates_dataset "datasets/sfdmu/q3/en-US/q3-rates"                                           # Q3 rates data

    sleep_default: &sleep_default 30   # Default sleep duration (in seconds) for wait tasks
#-------#
# TASKS #
#-------#

tasks:
  robot:
    options:
      suites: robot/rlm-base/tests
      options:
        outputdir: robot/rlm-base/results

  robot_testdoc:
    options:
      path: robot/rlm-base/tests
      output: robot/rlm-base/doc/rlm-base_tests.html

  run_tests:
    options:
      required_org_code_coverage_percent: 75

#--------------------------#
# CONTEXT DEFINITION TASKS #
#--------------------------#
  extend_context_contracts:
    description: Extend Standard Contracts Context Definition
    class_path: tasks.rlm_extend_stdctx.ExtendStandardContext
    group: Revenue Lifecycle Management
    options:
      name: *contracts_context_name
      description: "Extension of Standard Contracts Context Definition"
      developerName: *contracts_context_name
      baseReference: *contracts_context_base_reference
      startDate: *default_context_start_date
      contextTtl: *default_context_ttl
      defaultMapping: *contracts_context_default_mapping
      activate: true

  extend_context_contracts_extraction:
    description: Extend Standard Contracts Extraction Context Definition
    class_path: tasks.rlm_extend_stdctx.ExtendStandardContext
    group: Revenue Lifecycle Management
    options:
      name: *contracts_extraction_context_name
      description: "Extension of Standard Contracts Extraction Context Definition"
      developerName: *contracts_extraction_context_name
      baseReference: *contracts_extraction_context_base_reference
      startDate: *default_context_start_date
      contextTtl: *default_context_ttl
      defaultMapping: *contracts_extraction_context_default_mapping
      activate: true

  extend_context_asset:
    group: Revenue Lifecycle Management
    description: Extend Standard Asset Context
    class_path: tasks.rlm_extend_stdctx.ExtendStandardContext
    options:
      name: *asset_context_name
      description: "Extension of Standard Sales Transaction Context Definition"
      developerName: *asset_context_name
      baseReference: *asset_context_base_reference
      startDate: *default_context_start_date
      contextTtl: *default_context_ttl
      defaultMapping: *asset_context_default_mapping
      activate: true

  extend_context_sales_transaction:
    group: Revenue Lifecycle Management
    description: Extend Standard Sales Transaction Context
    class_path: tasks.rlm_extend_stdctx.ExtendStandardContext
    options:
      name: *sales_transaction_context_name
      description: "Extension of Standard Sales Transaction Context Definition"
      developerName: *sales_transaction_context_name
      baseReference: *sales_transaction_context_base_reference
      startDate: *default_context_start_date
      contextTtl: *default_context_ttl
      defaultMapping: *sales_transaction_context_default_mapping
      activate: true

  apply_context_constraint_engine_node_status:
    group: Revenue Lifecycle Management
    description: Apply ConstraintEngineNodeStatus mappings to Sales Transaction context
    class_path: tasks.rlm_context_service.ManageContextDefinition
    options:
      developer_name: *sales_transaction_context_name
      plan_file: datasets/context_plans/ConstraintEngineNodeStatus/manifest.json
      translate_plan: true
      deactivate_before: false
      activate: true
      verify: true

  extend_context_product_discovery:
    description: Extend Standard Product Discovery Context
    group: Revenue Lifecycle Management
    class_path: tasks.rlm_extend_stdctx.ExtendStandardContext
    options:
      name: *product_discovery_context_name
      description: "Extension of Standard Product Discovery Context Definition"
      developerName: *product_discovery_context_name
      baseReference: *product_discovery_context_base_reference
      startDate: *default_context_start_date
      contextTtl: *default_context_ttl
      defaultMapping: *product_discovery_context_default_mapping
      activate: true

  extend_context_cart:
    description: Extend Standard Cart Context
    group: Revenue Lifecycle Management
    class_path: tasks.rlm_extend_stdctx.ExtendStandardContext
    options:
      name: *cart_context_name
      description: "Extension of Standard Cart Context Definition"
      developerName: *cart_context_name
      baseReference: *cart_context_base_reference
      startDate: *default_context_start_date
      contextTtl: *default_context_ttl
      defaultMapping: *cart_context_default_mapping  
      activate: true

  extend_context_billing:
    description: Extend Standard Billing Context
    group: Revenue Lifecycle Management
    class_path: tasks.rlm_extend_stdctx.ExtendStandardContext
    options:
      name: *billing_context_name
      description: "Extension of Standard Billing Context Definition"
      developerName: *billing_context_name
      baseReference: *billing_context_base_reference
      startDate: *default_context_start_date
      contextTtl: *default_context_ttl
      defaultMapping: *billing_context_default_mapping
      activate: true

  extend_context_fulfillment_asset:
    description: Extend Standard Fulfillment Asset Context Definition
    group: Revenue Lifecycle Management
    class_path: tasks.rlm_extend_stdctx.ExtendStandardContext
    options:
      name: *fulfillment_asset_context_name
      description: "Extension of Standard Fulfillment Asset Context Definition"
      developerName: *fulfillment_asset_context_name
      baseReference: *fulfillment_asset_context_base_reference
      startDate: *default_context_start_date
      contextTtl: *default_context_ttl
      defaultMapping: *fulfillment_asset_context_default_mapping
      activate: true

  extend_context_collection_plan_segment:
    description: Extend Standard Collection Plan Segment Context Definition
    group: Revenue Lifecycle Management
    class_path: tasks.rlm_extend_stdctx.ExtendStandardContext
    options:
      name: *collection_plan_segment_context_name
      description: "Extension of Standard Collection Plan Segment Context Definition"
      developerName: *collection_plan_segment_context_name
      baseReference: *collection_plan_segment_context_base_reference
      startDate: *default_context_start_date
      contextTtl: *default_context_ttl
      defaultMapping: *collection_plan_segment_context_default_mapping
      activate: true

  extend_context_rate_management:
    description: Extend Standard Rate Management Context Definition
    group: Revenue Lifecycle Management
    class_path: tasks.rlm_extend_stdctx.ExtendStandardContext
    options:
      name: *rate_management_context_name
      description: "Extension of Standard Rate Management Context Definition"
      developerName: *rate_management_context_name
      baseReference: *rate_management_context_base_reference
      startDate: *default_context_start_date
      contextTtl: *default_context_ttl
      defaultMapping: *rate_management_context_default_mapping
      activate: true

  extend_context_rating_discovery:
    description: Extend Standard Rating Discovery Context Definition
    group: Revenue Lifecycle Management
    class_path: tasks.rlm_extend_stdctx.ExtendStandardContext
    options:
      name: *rating_discovery_context_name
      description: "Extension of Standard Rating Discovery Context Definition"
      developerName: *rating_discovery_context_name
      baseReference: *rating_discovery_context_base_reference
      startDate: *default_context_start_date
      contextTtl: *default_context_ttl
      defaultMapping: *rating_discovery_context_default_mapping
      activate: true

#--------------#
# DEPLOY TASKS #
#--------------#
# All deploy tasks are managed here and can be called in any order
# TODO: Organize pre/post deploy tasks into their own sections

  cleanup_settings_for_dev:
    description: Clean up settings files for dev scratch orgs (removes unsupported fields)
    class_path: tasks.rlm_cleanup_settings.CleanupSettingsForDev
    group: Revenue Lifecycle Management
    options:
      path: unpackaged/pre
      remove_for_scratch: true

  deploy_pre:
    description: Deploy Pre-deployment Metadata
    class_path: cumulusci.tasks.salesforce.DeployBundles
    group: Revenue Lifecycle Management
    options:
      path: unpackaged/pre

  restore_rc_tso:
    description: Move RC_TSO from storage directory for deployment (only when tso flag is true)
    class_path: tasks.rlm_restore_rc_tso.RestoreRCTSO
    group: Revenue Lifecycle Management
    options:
      path: unpackaged/pre

  deploy_rc_tso:
    description: Deploy RC_TSO Permission Set Group (only when tso flag is true)
    class_path: cumulusci.tasks.salesforce.Deploy
    group: Revenue Lifecycle Management
    options:
      path: unpackaged/pre/3_permissionsetgroups/RC_TSO.permissionsetgroup-meta.xml

  deploy_context_definitions:
    description: Deploy Context Definitions
    class_path: cumulusci.tasks.salesforce.Deploy
    group: Revenue Lifecycle Management
    options:
      path: force-app/main/default/contextDefinitions

  deploy_permissions:
    description: Deploy Permission Set Groups
    class_path: cumulusci.tasks.salesforce.Deploy
    group: Revenue Lifecycle Management
    options:
      path: force-app/main/default/permissionsetgroups

  deploy_decision_tables:
    description: Deploy Decision Tables
    class_path: cumulusci.tasks.salesforce.Deploy
    group: Revenue Lifecycle Management
    options:
      path: force-app/main/default/decisionTables

  deploy_agents_bots:
    description: Deploy Agentforce Agent Bots
    class_path: cumulusci.tasks.salesforce.Deploy
    group: Revenue Lifecycle Management
    options:
      path: unpackaged/post_agents/bots

  deploy_agents_genAiPlanners:
    description: Deploy Agentforce Agent Planner Bundles
    class_path: cumulusci.tasks.salesforce.Deploy
    group: Revenue Lifecycle Management
    options:
      path: unpackaged/post_agents/genAiPlannerBundles

  deploy_agents_genAiFunctions:
    description: Deploy Agentforce Agent Functions
    class_path: cumulusci.tasks.salesforce.Deploy
    group: Revenue Lifecycle Management
    options:
      path: unpackaged/post_agents/genAiFunctions

  deploy_agents_genAiPlugins:
    description: Deploy Agentforce Agent Plugins
    class_path: cumulusci.tasks.salesforce.Deploy
    group: Revenue Lifecycle Management
    options:
      path: unpackaged/post_agents/genAiPlugins

  deploy_agents_flows:
    description: Deploy Agentforce Agent Flows
    class_path: cumulusci.tasks.salesforce.Deploy
    group: Revenue Lifecycle Management
    options:
      path: unpackaged/post_agents/flows

  deploy_agents_settings:
    description: Deploy Agentforce Agent Settings
    class_path: cumulusci.tasks.salesforce.Deploy
    group: Revenue Lifecycle Management
    options:
      path: unpackaged/post_agents/settings

  deploy_agents_permissionsets:
    description: Deploy Agentforce Agent Permissionsets
    class_path: cumulusci.tasks.salesforce.Deploy
    group: Revenue Lifecycle Management
    options:
      path: unpackaged/post_agents/permissionsets
  
  deploy_agents:
    description: Deploy Agentforce Agent Configurations
    class_path: cumulusci.tasks.salesforce.Deploy
    group: Revenue Lifecycle Management
    options:
      path: unpackaged/post_agents

  deploy_sharing_rules:
    description: Deploy Sharing Rules
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/post_sharing

  deploy_quantumbit:
    description: Deploy QuantumBit Metadata
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/post_quantumbit

  deploy_post_scratch:
    description: Deploy Scratch Metadata
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/post_scratch

  deploy_post_tso:
    description: Deploy Trialforce Source Org Metadata
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/post_tso

  deploy_post_prm:
    description: Deploy Partner Relationship Management Metadata
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/post_prm

  deploy_post_approvals:
    description: Deploy Advanced Approvals Metadata
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/post_approvals
  
  deploy_post_docgen:
    description: Deploy Document Generation Metadata
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/post_docgen

  deploy_post_constraints:
    description: Deploy Constraints Metadata
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/post_constraints

  deploy_post_utils:
    description: Deploy Utils Metadata
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/post_utils

  deploy_post_commerce:
    description: Deploy Commerce Metadata (e.g. Commerce decision table flows)
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/post_commerce

  deploy_post_procedureplans:
    description: Deploy Procedure Plans Metadata
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/post_procedureplans
  
  deploy_post_procedureplans_objects:
    description: Deploy Procedure Plans Objects
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/post_procedureplans/objects

  deploy_post_procedureplans_classes:
    description: Deploy Procedure Plans Classes
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/post_procedureplans/classes

  deploy_post_procedureplans_permissionsets:
    description: Deploy Procedure Plans Permissionsets
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/post_procedureplans/permissionsets

  deploy_post_billing:
    description: Deploy Billing Metadata
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/post_billing

  deploy_billing_id_settings:
    description: Deploy Billing Settings with org-specific record IDs (resolved via XPath transform queries at deploy time)
    class_path: cumulusci.tasks.salesforce.Deploy
    group: Revenue Lifecycle Management
    options:
      path: unpackaged/post_billing_id_settings
      transforms:
        - transform: find_replace
          options:
            patterns:
              - xpath: //BillingSettings/defaultBillingTreatment[text()="__DEFAULT_BILLING_TREATMENT_ID__"]
                replace_record_id_query: SELECT Id FROM BillingTreatment WHERE Name = 'Billing Treatment - USA - Advance' AND Status = 'Active' LIMIT 1
                api: rest
              - xpath: //BillingSettings/defaultLegalEntity[text()="__DEFAULT_LEGAL_ENTITY_ID__"]
                replace_record_id_query: SELECT Id FROM LegalEntity WHERE Name = 'Default Legal Entity - US' LIMIT 1
                api: rest
              - xpath: //BillingSettings/defaultTaxTreatment[text()="__DEFAULT_TAX_TREATMENT_ID__"]
                replace_record_id_query: SELECT Id FROM TaxTreatment WHERE Name = 'Default Tax Policy' AND Status = 'Active' LIMIT 1
                api: rest

  deploy_billing_template_settings:
    description: Re-enable Invoice Email/PDF toggles to trigger default template auto-creation (cycle step 3)
    class_path: cumulusci.tasks.salesforce.Deploy
    group: Revenue Lifecycle Management
    options:
      path: unpackaged/post_billing_template_settings

  deploy_post_guidedselling:
    description: Deploy Guided Selling Metadata
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/post_guidedselling

  deploy_post_visualization:
    description: Deploy Visualization Metadata (Flow with Visuals, LWC styling)
    class_path: cumulusci.tasks.salesforce.DeployBundles
    options:
      path: unpackaged/post_visualization
      collision_check: False

  deploy_post_payments:
    description: Deploy Payments Metadata
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/post_payments

  deploy_post_payments_site:
    description: Deploy Payments site settings only
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/post_payments/sites

  deploy_post_payments_settings:
    description: Deploy Payments Settings
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/post_payments_settings

  ensure_pricing_schedules:
    description: Ensure pricing schedules exist before expression sets
    class_path: tasks.rlm_repair_pricing_schedules.EnsurePricingSchedules
    options:
      disable_settings_path: tasks/resources/pricing_settings_disable
      enable_settings_path: unpackaged/pre/2_settings

  deploy_expression_sets:
    description: Deploy Expression Sets
    class_path: cumulusci.tasks.salesforce.Deploy
    group: Revenue Lifecycle Management
    options:
      path: force-app/main/default/expressionSetDefinition
      transforms:
        - transform: find_replace
          options:
            patterns:
              - xpath: //ExpressionSetDefinition/versions/variables/value[text()="__ATTRIBUTEPasID__"]
                replace_record_id_query: SELECT Id from PriceAdjustmentSchedule WHERE name = 'Standard Attribute Based Adjustment' LIMIT 1
                api: rest
              - xpath: //ExpressionSetDefinition/versions/variables/value[text()="__VOLUMEPasID__"]
                replace_record_id_query: SELECT Id from PriceAdjustmentSchedule WHERE name = 'Standard Price Adjustment Tier' LIMIT 1
                api: rest
              - xpath: //ExpressionSetDefinition/versions/variables/value[text()="__BUNDLEPasID__"]
                replace_record_id_query: SELECT Id from PriceAdjustmentSchedule WHERE name = 'Standard Bundle Based Adjustment' LIMIT 1
                api: rest

  activate_and_deploy_expression_sets:
    description: Activate and Deploy Expression Sets
    class_path: cumulusci.tasks.salesforce.Deploy
    group: Revenue Lifecycle Management
    options:
      path: force-app/main/default/expressionSetDefinition
      transforms:
        - transform: find_replace
          options:
            patterns:
              - xpath: //ExpressionSetDefinition/versions/status[text()="Draft"]
                replace: Active
                api: rest
              - xpath: //ExpressionSetDefinition/versions/variables/value[text()="__ATTRIBUTEPasID__"]
                replace_record_id_query: SELECT Id from PriceAdjustmentSchedule WHERE name = 'Standard Attribute Based Adjustment' LIMIT 1
                api: rest
              - xpath: //ExpressionSetDefinition/versions/variables/value[text()="__VOLUMEPasID__"]
                replace_record_id_query: SELECT Id from PriceAdjustmentSchedule WHERE name = 'Standard Price Adjustment Tier' LIMIT 1
                api: rest
              - xpath: //ExpressionSetDefinition/versions/variables/value[text()="__BUNDLEPasID__"]
                replace_record_id_query: SELECT Id from PriceAdjustmentSchedule WHERE name = 'Standard Bundle Based Adjustment' LIMIT 1
                api: rest

  deploy_full:
    description: Deploy all metadata
    class_path: cumulusci.tasks.salesforce.Deploy
    group: Revenue Lifecycle Management
    options:
      path: force-app/main/default
      transforms:
        - transform: find_replace
          options:
            patterns:
              - xpath: //ExpressionSetDefinition/versions/variables/value[text()="__ATTRIBUTEPasID__"]
                replace_record_id_query: SELECT Id from PriceAdjustmentSchedule WHERE name = 'Standard Attribute Based Adjustment' LIMIT 1
                api: rest
              - xpath: //ExpressionSetDefinition/versions/variables/value[text()="__VOLUMEPasID__"]
                replace_record_id_query: SELECT Id from PriceAdjustmentSchedule WHERE name = 'Standard Price Adjustment Tier' LIMIT 1
                api: rest
              - xpath: //ExpressionSetDefinition/versions/variables/value[text()="__BUNDLEPasID__"]
                replace_record_id_query: SELECT Id from PriceAdjustmentSchedule WHERE name = 'Standard Bundle Based Adjustment' LIMIT 1
                api: rest

  deploy_org_settings:
    description: Deploy Org Settings
    class_path: cumulusci.tasks.salesforce.Deploy
    group: Revenue Lifecycle Management
    options:
      path: force-app/main/default/settings

  create_partner_central:
    description: Create Partner Central Community
    class_path: cumulusci.tasks.salesforce.CreateCommunity
    options:
      name: "rlm"
      description: "RLM Partner Digital Experience"
      template: "Partner Central (Enhanced)"
      url_path_prefix: "partners"
      skip_existing: true

  create_payments_webhook:
    description: Create Salesforce Payments Webhook
    class_path: cumulusci.tasks.salesforce.CreateCommunity
    options:
      name: "Payments Webhook"
      description: "RLM Salesforce Payments Webhook"
      template: "Build Your Own (LWR)"
      url_path_prefix: "sfpwebhook"
      skip_existing: true


#------------------#
# SFDMU DATA TASKS #
#------------------#
# These tasks use the SFDMU (Salesforce Data Move Utility) to load data into the org.
# Each task references a dataset anchor defined earlier, specifying the path to the data to load.
# Data tasks are grouped by feature (QuantumBit, Q3, CLM, etc.) and data type (product, billing, tax, etc.).
# These tasks are essential for seeding orgs with test or reference data during deployment.

  load_sfdmu_data:
    group: Revenue Lifecycle Management
    description: Load SFDMU Data
    class_path: tasks.rlm_sfdmu.LoadSFDMUData

  insert_quantumbit_pcm_data:
    group: Revenue Lifecycle Management
    description: Insert QuantumBit Data
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *quantumbit_product_dataset

  insert_quantumbit_pricing_data:
    group: Revenue Lifecycle Management
    description: Insert QuantumBit Data
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *quantumbit_pricing_dataset

  insert_quantumbit_product_image_data:
    group: Revenue Lifecycle Management
    description: Insert QuantumBit Product Image Data
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *quantumbit_product_image_dataset

  insert_q3_data:
    group: Revenue Lifecycle Management
    description: Insert Q3 Data
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *q3_product_dataset

  insert_clm_data:
    group: Revenue Lifecycle Management
    description: Insert CLM Data
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *quantumbit_clm_dataset

  insert_clm_data_prod:
    group: Revenue Lifecycle Management
    description: Insert CLM Data to Production
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *quantumbit_clm_dataset

  insert_qb_dro_data:
    group: Revenue Lifecycle Management
    description: Insert QuantumBit DRO Data (scratch and prod; AssignedTo resolved from target org)
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *quantumbit_dro_dataset
      dynamic_assigned_to_user: true

  insert_q3_dro_data_scratch:
    group: Revenue Lifecycle Management
    description: Insert Q3 DRO Data to Scratch
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *q3_dro_dataset
      dynamic_assigned_to_user: true

  insert_q3_dro_data_prod:
    group: Revenue Lifecycle Management
    description: Insert Q3 DRO Data to Production
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *q3_dro_dataset
      dynamic_assigned_to_user: true

  insert_tax_data:
    group: Revenue Lifecycle Management
    description: Insert QuantumBit Tax Data
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *quantumbit_tax_dataset


  insert_q3_tax_data:
    group: Revenue Lifecycle Management
    description: Insert Q3 Tax Data
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *q3_tax_dataset


  insert_billing_data:
    group: Revenue Lifecycle Management
    description: Insert QuantumBit Billing Data
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *quantumbit_billing_dataset


  insert_q3_billing_data:
    group: Revenue Lifecycle Management
    description: Insert Q3 Billing Data
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *q3_billing_dataset


  insert_qb_rating_data:
    group: Revenue Lifecycle Management
    description: Insert QuantumBit Rating Data
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *quantumbit_rating_dataset

  
  insert_q3_rating_data:
    group: Revenue Lifecycle Management
    description: Insert Q3 Rating Data
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *q3_rating_dataset


  insert_qb_rates_data:
    group: Revenue Lifecycle Management
    description: Insert QuantumBit Rates Data
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *quantumbit_rates_dataset


  insert_q3_rates_data:
    group: Revenue Lifecycle Management
    description: Insert Q3 Rates Data
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *q3_rates_dataset


  insert_scratch_data:
    group: Revenue Lifecycle Management
    description: Insert Scratch Data
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: "datasets/sfdmu/scratch_data"

  insert_qb_constraints_product_data:
    group: Revenue Lifecycle Management
    description: Insert QuantumBit Constraints Product Data
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *quantumbit_constraints_product_dataset

  insert_qb_constraints_component_data:
    group: Revenue Lifecycle Management
    description: Insert QuantumBit Constraints Product Related Component Data
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *quantumbit_constraints_component_dataset

  # --- CML Constraint Model Tasks ---
  export_cml:
    group: Revenue Lifecycle Management
    description: Export constraint model data (ESDV, ESC, reference objects, blob) from org to local directory
    class_path: tasks.rlm_cml.ExportCML

  import_cml:
    group: Revenue Lifecycle Management
    description: Import constraint model metadata, ESC associations, and ConstraintModel blob into org
    class_path: tasks.rlm_cml.ImportCML

  validate_cml:
    group: Revenue Lifecycle Management
    description: Validate CML file structure, annotations, and ESC association coverage
    class_path: tasks.rlm_cml.ValidateCML

  insert_qb_transactionprocessingtypes_data:
    group: Revenue Lifecycle Management
    description: Insert QuantumBit Transaction Processing Types Data
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *quantumbit_transactionprocessingtypes_dataset

  insert_qb_guidedselling_data:
    group: Revenue Lifecycle Management
    description: Insert QuantumBit Guided Selling Data
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *quantumbit_guidedselling_dataset
  
  deactivate_decision_tables:
    group: Revenue Lifecycle Management
    description: Deactivate Decision Tables (required before updating active decision tables)
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/apex/deactivateDecisionTables.apex

  exclude_active_decision_tables:
    group: Revenue Lifecycle Management
    description: "Exclude active decision tables from deployment (TODO: implement proper deactivation)"
    class_path: tasks.rlm_exclude_active_decision_tables.ExcludeActiveDecisionTables
    options:
      path: unpackaged/pre/5_decisiontables

  restore_decision_tables:
    group: Revenue Lifecycle Management
    description: "Restore skipped decision tables after deploy"
    class_path: tasks.rlm_exclude_active_decision_tables.RestoreDecisionTables
    options:
      path: unpackaged/pre/5_decisiontables

  assign_permission_set_groups_tolerant:
    group: Revenue Lifecycle Management
    description: "Assign Permission Set Groups with tolerance for permission warnings"
    class_path: tasks.rlm_assign_permission_set_groups.AssignPermissionSetGroupsTolerant
    options:
      api_names:
        description: "API Developer Names of desired Permission Set Groups"
        required: True
      user_alias:
        description: "Alias of target user (if not the current running user)"
        required: False

  recalculate_permission_set_groups:
    group: Revenue Lifecycle Management
    description: Recalculate permission set groups and wait for Updated status
    class_path: tasks.rlm_recalculate_permission_set_groups.RecalculatePermissionSetGroups
    options:
      api_names:
        description: "API Developer Names of Permission Set Groups to recalculate"
        required: True
      timeout_seconds: 300
      poll_seconds: 10
      trigger_recalc: true
      initial_delay_seconds: 60
      retry_count: 2
      retry_delay_seconds: 120
      post_trigger_delay_seconds: 90
      use_tooling_api: false

  activate_decision_tables:
    group: Revenue Lifecycle Management
    description: Activate selected Decision Tables via API
    class_path: tasks.rlm_manage_decision_tables.ManageDecisionTables
    options:
      operation: activate
      developer_names: *dt_activation_decision_tables

  activate_expression_sets:
    group: Revenue Lifecycle Management
    description: Activate expression set versions via Tooling API
    class_path: tasks.rlm_manage_expression_sets.ManageExpressionSets
    options:
      operation: activate_versions
      metadata_path: force-app/main/default/expressionSetDefinition

  deactivate_expression_sets:
    group: Revenue Lifecycle Management
    description: Deactivate expression set versions via Tooling API
    class_path: tasks.rlm_manage_expression_sets.ManageExpressionSets
    options:
      operation: deactivate_versions
      metadata_path: force-app/main/default/expressionSetDefinition

#------------#
# APEX TASKS #
#------------#
# These tasks execute anonymous Apex scripts to perform setup or data manipulation in the org.
# Each task references a script in the scripts/apex directory.
# These are typically used for post-deployment configuration, data activation, or custom logic.

  create_rule_library:
    group: Revenue Lifecycle Management
    description: Create Rule Library
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/apex/createRuleLibrary.apex

  create_docgen_library:
    group: Revenue Lifecycle Management
    description: Create DocGen Library
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/apex/createDocgenTemplateLibrary.apex

  enable_document_builder_toggle:
    group: Revenue Lifecycle Management
    description: Enable the Document Builder toggle on Revenue Settings (Robot test with sf org open). Run before deploy_post_docgen when the org does not have Document Builder enabled via metadata.
    class_path: tasks.rlm_enable_document_builder_toggle.EnableDocumentBuilderToggle
    options:
      suite: robot/rlm-base/tests/setup/enable_document_builder.robot
      outputdir: robot/rlm-base/results

  enable_constraints_settings:
    group: Revenue Lifecycle Management
    description: "Set Default Transaction Type, Asset Context for Product Configurator, and enable Constraints Engine toggle on Revenue Settings (Robot test). Required before CML constraint data import."
    class_path: tasks.rlm_enable_constraints_settings.EnableConstraintsSettings
    options:
      suite: robot/rlm-base/tests/setup/enable_constraints_settings.robot
      outputdir: robot/rlm-base/results
      default_transaction_type: Advanced Configurator
      asset_context: RLM_AssetContext

  validate_setup:
    group: Revenue Lifecycle Management
    description: >
      Validate the local developer setup for rlm-base-dev. Checks Python,
      CumulusCI, Salesforce CLI, SFDMU plugin version (v5+ required), Node.js,
      Robot Framework, SeleniumLibrary, webdriver-manager, Chrome/Chromium,
      ChromeDriver, and urllib3. When
      auto_fix=true the SFDMU plugin is automatically installed or updated to
      the required version. Run without an org: cci task run validate_setup
    class_path: tasks.rlm_validate_setup.ValidateSetup
    options:
      auto_fix: true
      required_sfdmu_version: "5.0.0"
      fail_on_error: true

  configure_revenue_settings:
    group: Revenue Lifecycle Management
    description: "Configure Revenue Settings page defaults: Pricing Procedure, Usage Rating, Instant Pricing toggle, and Create Orders from Quote flow (Robot test). Must run after all data/metadata is deployed and before decision table refresh."
    class_path: tasks.rlm_configure_revenue_settings.ConfigureRevenueSettings
    options:
      suite: robot/rlm-base/tests/setup/configure_revenue_settings.robot
      outputdir: robot/rlm-base/results
      pricing_procedure: RLM Revenue Management Default Pricing Procedure
      usage_rating_procedure: RLM Default Rating Discovery Procedure
      create_orders_flow: RC_CreateOrdersFromQuote

  reconfigure_pricing_discovery:
    group: Revenue Lifecycle Management
    description: "Reconfigure the autoproc Salesforce_Default_Pricing_Discovery_Procedure expression set: fix context definition, set rank and start date, and reactivate. Required before decision table refresh."
    class_path: tasks.rlm_reconfigure_expression_set.ReconfigureExpressionSet
    options:
      expression_set_name: Salesforce_Default_Pricing_Discovery_Procedure
      context_definition_name: *sales_transaction_context_name
      rank: 1
      start_date: "2020-01-01T00:00:00.000Z"

  create_dro_rule_library:
    group: Revenue Lifecycle Management
    description: Create DRO Rule Library
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/apex/createDRORuleLibrary.apex

  create_tax_engine:
    group: Revenue Lifecycle Management
    description: Create Tax Engine
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/apex/createTaxEngine.apex

  activate_default_payment_term:
    group: Revenue Lifecycle Management
    description: Activate Default Payment Term
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/apex/activateDefaultPaymentTerm.apex

  activate_billing_records:
    group: Revenue Lifecycle Management
    description: Activate Billing Records
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/apex/activateBillingRecords.apex

  query_billing_state:
    group: Revenue Lifecycle Management
    description: Query billing record state (PaymentTerm, BillingTreatment, BillingPolicy, BillingTreatmentItem) for validation; check debug logs for output.
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/apex/query_billing_state.apex

  delete_draft_billing_records:
    group: Revenue Lifecycle Management
    description: Delete all draft billing-related records (BillingTreatmentItem, BillingTreatment, BillingPolicy, PaymentTermItem, PaymentTerm) in dependency order. Use before re-running the billing data plan to avoid duplicates.
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/apex/deleteDraftBillingRecords.apex

  validate_billing_structure:
    group: Revenue Lifecycle Management
    description: Validate that every BillingTreatment has BillingPolicyId set. Run after data load to verify structure before activation.
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/apex/validateBillingStructure.apex

  activate_tax_records:
    group: Revenue Lifecycle Management
    description: Activate Tax Records
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/apex/activateTaxRecords.apex

  activate_price_adjustment_schedules:
    group: Revenue Lifecycle Management
    description: Activate Price Adjustment Schedules
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/apex/activatePriceAdjustmentSchedules.apex

  activate_rating_records:
    group: Revenue Lifecycle Management
    description: Activate Rating Records
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/apex/activateRatingRecords.apex

  activate_rates:
    group: Revenue Lifecycle Management
    description: Activate Rates
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/apex/activateRateCardEntries.apex


#--------------------#
# EXTRACTION TASKS   #
#--------------------#
# Extract tasks for each QB plan are under the Data Management - Extract group (extract_qb_*_data).
# Post-process script makes extracted CSVs re-import-ready (composite keys, header normalization).

  post_process_extraction:
    group: Revenue Lifecycle Management
    description: Post-process extracted CSVs into import-ready format
    class_path: cumulusci.tasks.command.Command
    options:
      command: "python3 scripts/post_process_extraction.py {extraction_dir} {plan_dir}"

#-------------------------------------#
# DATA MANAGEMENT: EXTRACT & TEST      #
#-------------------------------------#
# Extract tasks (group: Data Management - Extract): SFDMU org  CSV. Output in datasets/sfdmu/extractions/<plan_name>/<timestamp>. Post-process runs by default; re-import-ready CSVs in <timestamp>/processed/.
# Idempotency tasks (group: Data Management - Idempotency): run plan load twice, assert no record count increase. Use --group to list or run by group.

  extract_qb_pcm_data:
    group: Data Management - Extract
    description: "Extract qb-pcm (product catalog) from org to CSV. Output in datasets/sfdmu/extractions/qb-pcm/<timestamp>. Runs post-process by default; re-import-ready CSVs in <timestamp>/processed/. Use run_post_process false to skip."
    class_path: tasks.rlm_sfdmu.ExtractSFDMUData
    options:
      pathtoexportjson: *quantumbit_product_dataset

  extract_qb_pricing_data:
    group: Data Management - Extract
    description: "Extract qb-pricing from org to CSV. Output in datasets/sfdmu/extractions/qb-pricing/<timestamp>. Runs post-process by default; re-import-ready CSVs in <timestamp>/processed/. Use run_post_process false to skip."
    class_path: tasks.rlm_sfdmu.ExtractSFDMUData
    options:
      pathtoexportjson: *quantumbit_pricing_dataset

  extract_qb_product_images_data:
    group: Data Management - Extract
    description: "Extract qb-product-images from org to CSV. Output in datasets/sfdmu/extractions/qb-product-images/<timestamp>. Runs post-process by default; re-import-ready CSVs in <timestamp>/processed/. Use run_post_process false to skip."
    class_path: tasks.rlm_sfdmu.ExtractSFDMUData
    options:
      pathtoexportjson: *quantumbit_product_image_dataset

  extract_qb_dro_data:
    group: Data Management - Extract
    description: "Extract qb-dro from org to CSV. Output in datasets/sfdmu/extractions/qb-dro/<timestamp>. Runs post-process by default; re-import-ready CSVs in <timestamp>/processed/. Use run_post_process false to skip."
    class_path: tasks.rlm_sfdmu.ExtractSFDMUData
    options:
      pathtoexportjson: *quantumbit_dro_dataset

  extract_qb_clm_data:
    group: Data Management - Extract
    description: "Extract qb-clm from org to CSV. Output in datasets/sfdmu/extractions/qb-clm/<timestamp>. Runs post-process by default; re-import-ready CSVs in <timestamp>/processed/. Use run_post_process false to skip."
    class_path: tasks.rlm_sfdmu.ExtractSFDMUData
    options:
      pathtoexportjson: *quantumbit_clm_dataset

  extract_qb_rating_data:
    group: Data Management - Extract
    description: "Extract qb-rating from org to CSV. Output in datasets/sfdmu/extractions/qb-rating/<timestamp>. Runs post-process by default; re-import-ready CSVs in <timestamp>/processed/. Use run_post_process false to skip."
    class_path: tasks.rlm_sfdmu.ExtractSFDMUData
    options:
      pathtoexportjson: *quantumbit_rating_dataset

  extract_qb_rates_data:
    group: Data Management - Extract
    description: "Extract qb-rates from org to CSV. Output in datasets/sfdmu/extractions/qb-rates/<timestamp>. Runs post-process by default; re-import-ready CSVs in <timestamp>/processed/. Use run_post_process false to skip."
    class_path: tasks.rlm_sfdmu.ExtractSFDMUData
    options:
      pathtoexportjson: *quantumbit_rates_dataset

  extract_qb_transactionprocessingtypes_data:
    group: Data Management - Extract
    description: "Extract qb-transactionprocessingtypes from org to CSV. Output in datasets/sfdmu/extractions/qb-transactionprocessingtypes/<timestamp>. Runs post-process by default; re-import-ready CSVs in <timestamp>/processed/. Use run_post_process false to skip."
    class_path: tasks.rlm_sfdmu.ExtractSFDMUData
    options:
      pathtoexportjson: *quantumbit_transactionprocessingtypes_dataset

  extract_qb_guidedselling_data:
    group: Data Management - Extract
    description: "Extract qb-guidedselling from org to CSV. Output in datasets/sfdmu/extractions/qb-guidedselling/<timestamp>. Runs post-process by default; re-import-ready CSVs in <timestamp>/processed/. Use run_post_process false to skip."
    class_path: tasks.rlm_sfdmu.ExtractSFDMUData
    options:
      pathtoexportjson: *quantumbit_guidedselling_dataset

  test_qb_pcm_idempotency:
    group: Data Management - Idempotency
    description: Idempotency test for qb-pcm (product catalog). Uses extraction roundtrip by default (extract -> post-process -> load) and writes to datasets/sfdmu/extractions/qb-pcm/<timestamp>.
    class_path: tasks.rlm_sfdmu.TestSFDMUIdempotency
    options:
      pathtoexportjson: *quantumbit_product_dataset
      use_extraction_roundtrip: true
      persist_extraction_output: true

  test_qb_pricing_idempotency:
    group: Data Management - Idempotency
    description: Idempotency test for qb-pricing (load twice from source, assert no new records).
    class_path: tasks.rlm_sfdmu.TestSFDMUIdempotency
    options:
      pathtoexportjson: *quantumbit_pricing_dataset
      use_extraction_roundtrip: false

  test_qb_product_images_idempotency:
    group: Data Management - Idempotency
    description: Idempotency test for qb-product-images.
    class_path: tasks.rlm_sfdmu.TestSFDMUIdempotency
    options:
      pathtoexportjson: *quantumbit_product_image_dataset
      use_extraction_roundtrip: false

  test_qb_dro_idempotency:
    group: Data Management - Idempotency
    description: "Idempotency test for qb-dro. Note: plan uses dynamic_assigned_to_user for load; test runs without it (scratch org user may differ)."
    class_path: tasks.rlm_sfdmu.TestSFDMUIdempotency
    options:
      pathtoexportjson: *quantumbit_dro_dataset
      use_extraction_roundtrip: false

  test_qb_clm_idempotency:
    group: Data Management - Idempotency
    description: Idempotency test for qb-clm.
    class_path: tasks.rlm_sfdmu.TestSFDMUIdempotency
    options:
      pathtoexportjson: *quantumbit_clm_dataset
      use_extraction_roundtrip: false

  test_qb_rating_idempotency:
    group: Data Management - Idempotency
    description: Idempotency test for qb-rating.
    class_path: tasks.rlm_sfdmu.TestSFDMUIdempotency
    options:
      pathtoexportjson: *quantumbit_rating_dataset
      use_extraction_roundtrip: false

  test_qb_rates_idempotency:
    group: Data Management - Idempotency
    description: Idempotency test for qb-rates.
    class_path: tasks.rlm_sfdmu.TestSFDMUIdempotency
    options:
      pathtoexportjson: *quantumbit_rates_dataset
      use_extraction_roundtrip: false

  test_qb_transactionprocessingtypes_idempotency:
    group: Data Management - Idempotency
    description: Idempotency test for qb-transactionprocessingtypes.
    class_path: tasks.rlm_sfdmu.TestSFDMUIdempotency
    options:
      pathtoexportjson: *quantumbit_transactionprocessingtypes_dataset
      use_extraction_roundtrip: false

  test_qb_guidedselling_idempotency:
    group: Data Management - Idempotency
    description: Idempotency test for qb-guidedselling.
    class_path: tasks.rlm_sfdmu.TestSFDMUIdempotency
    options:
      pathtoexportjson: *quantumbit_guidedselling_dataset
      use_extraction_roundtrip: false

#------------------#
# PYTHON CCI TASKS #
#------------------#
# These tasks are custom Python tasks implemented in the tasks/ directory.
# They are used for advanced automation, data refresh, and business logic not covered by standard CumulusCI tasks.
# Each task references a class_path to a Python class that implements the logic.

  sync_pricing_data:
    description: Sync Pricing Data
    class_path: tasks.rlm_sync_pricing_data.SyncPricingData
    group: Revenue Lifecycle Management

  refresh_dt_rating:
    group: Revenue Lifecycle Management
    description: Refresh Rating Decision Tables
    class_path: tasks.rlm_refresh_decision_table.RefreshDecisionTable
    options:
      developerNames: *dt_rating_decision_tables

  refresh_dt_rating_discovery:
    group: Revenue Lifecycle Management
    description: Refresh Rating Discovery Decision Tables
    class_path: tasks.rlm_refresh_decision_table.RefreshDecisionTable
    options:
      developerNames: *dt_rating_discovery_decision_tables

  refresh_dt_default_pricing:
    group: Revenue Lifecycle Management
    description: Refresh Default Pricing Decision Tables
    class_path: tasks.rlm_refresh_decision_table.RefreshDecisionTable
    options:
      developerNames: *dt_default_pricing_decision_tables

  refresh_dt_pricing_discovery:
    group: Revenue Lifecycle Management
    description: Refresh Pricing Discovery Decision Tables
    class_path: tasks.rlm_refresh_decision_table.RefreshDecisionTable
    options:
      developerNames: *dt_pricing_discovery_decision_tables

  refresh_dt_asset:
    group: Revenue Lifecycle Management
    description: Refresh Asset Decision Tables
    class_path: tasks.rlm_refresh_decision_table.RefreshDecisionTable
    options:
      developerNames: *dt_asset_decision_tables

  refresh_dt_commerce:
    group: Revenue Lifecycle Management
    description: Refresh Commerce Decision Tables (when commerce flag is true)
    class_path: tasks.rlm_refresh_decision_table.RefreshDecisionTable
    options:
      developerNames: *dt_commerce_decision_tables

  manage_decision_tables:
    group: Revenue Lifecycle Management
    description: "Decision Table management: list (with UsageType), query, refresh, activate, deactivate, validate_lists (compare org to project list anchors)"
    class_path: tasks.rlm_manage_decision_tables.ManageDecisionTables
    options:
      operation: list  # Options: 'list', 'query', 'refresh', 'activate', 'deactivate', 'validate_lists'
      status: Active   # Filter by status
      is_incremental: false  # For refresh: true for incremental, false for full
      sort_by: LastSyncDate
      sort_order: Desc

  manage_flows:
    group: Revenue Lifecycle Management
    description: Comprehensive Flow management (list, query, activate, deactivate)
    class_path: tasks.rlm_manage_flows.ManageFlows
    options:
      operation: list  # Options: 'list', 'query', 'activate', 'deactivate'
      status: null     # Filter by status (Active, Inactive, Draft, or null for all)
      process_type: null  # Filter by ProcessType (AutoLaunchedFlow, ScreenFlow, etc.)
      sort_by: LastModifiedDate
      sort_order: Desc

  manage_expression_sets:
    group: Revenue Lifecycle Management
    description: Comprehensive Expression Set management (list, query, manage versions)
    class_path: tasks.rlm_manage_expression_sets.ManageExpressionSets
    options:
      operation: list  # Options: 'list', 'query', 'list_versions', 'activate_version', 'deactivate_version'
      status: null     # Filter by status (Active, Inactive, Draft, or null for all)
      interface_source_type: null  # Filter by InterfaceSourceType (PricingProcedure, RatingProcedure, etc.)
      process_type: null  # Filter by ProcessType (DefaultPricing, DefaultRating, etc.)
      version_full_name: null  # For version operations: Full name of the version
      version_full_names: null  # For bulk version operations: list or comma-separated FullName values
      metadata_path: force-app/main/default/expressionSetDefinition  # For bulk operations when version names are omitted
      sort_by: LastModifiedDate
      sort_order: Desc

  manage_transaction_processing_types:
    group: Revenue Lifecycle Management
    description: Manage TransactionProcessingType entries via Tooling API
    class_path: tasks.rlm_manage_transaction_processing_types.ManageTransactionProcessingTypes
    options:
      operation: list  # Options: 'list', 'upsert'
      input_file: null  # Required for upsert; JSON array of records
      key_field: DeveloperName
      api_version: null
      dry_run: false

  manage_context_definition:
    group: Revenue Lifecycle Management
    description: Modify context definitions via Context Service (connect) endpoints
    class_path: tasks.rlm_context_service.ManageContextDefinition
    options:
      context_definition_id: null
      developer_name: null
      plan_file: null
      activate: false
      dry_run: false

  extend_standard_context:
    group: Revenue Lifecycle Management
    description: Extend a standard context definition and optionally apply a plan
    class_path: tasks.rlm_extend_stdctx.ExtendStandardContext
    options:
      name: null
      description: null
      developerName: null
      baseReference: null
      startDate: null
      contextTtl: null
      defaultMapping: null
      activate: true
      plan_file: null

  create_procedure_plan_definition:
    group: Revenue Lifecycle Management
    description: Create Procedure Plan Definition via Connect API (idempotent)
    class_path: tasks.rlm_create_procedure_plan_def.CreateProcedurePlanDefinition
    options:
      description: *procedure_plan_definition_description
      developerName: *procedure_plan_definition_developer_name
      name: *procedure_plan_definition_name
      primaryObject: *procedure_plan_definition_primary_object
      processType: *procedure_plan_definition_process_type
      versionActive: *procedure_plan_definition_version_active
      context_definition_label: *context_definition_label
      versionReadContextMapping: *procedure_plan_definition_version_read_context_mapping
      versionSaveContextMapping: *procedure_plan_definition_version_save_context_mapping
      versionEffectiveFrom: *procedure_plan_definition_version_effective_from
      versionDeveloperName: *procedure_plan_definition_version_developer_name
      versionRank: *procedure_plan_definition_version_rank
      versionEffectiveTo: *procedure_plan_definition_version_effective_to

  insert_procedure_plan_data:
    group: Revenue Lifecycle Management
    description: Insert Procedure Plan data (sections in pass 1, options with expression set links in pass 2)
    class_path: tasks.rlm_sfdmu.LoadSFDMUData
    options:
      pathtoexportjson: *procedure_plans_dataset

  activate_procedure_plan_version:
    group: Revenue Lifecycle Management
    description: Activate the ProcedurePlanDefinitionVersion after sections and options have been inserted
    class_path: tasks.rlm_create_procedure_plan_def.ActivateProcedurePlanVersion
    options:
      developerName: *procedure_plan_definition_developer_name

  activate_procedure_plan_expression_sets:
    group: Revenue Lifecycle Management
    description: Activate Procedure Plan expression set versions (RC_Price_Distribution_Procedure; RLM_DefaultPricingProcedure is activated by the main activate_expression_sets task)
    class_path: tasks.rlm_manage_expression_sets.ManageExpressionSets
    options:
      operation: activate_versions
      version_full_names: RC_Price_Distribution_Procedure_V1


#----------------#
# MAIN CCI FLOWS #
#----------------#
# This section defines the main CumulusCI flows for this project.
# Flows are ordered sequences of tasks and/or sub-flows that automate complex deployment and setup processes.
# Each flow is grouped by feature or deployment phase, and steps can include conditional logic (when) to control execution.
# The main flow (prepare_rlm_org) orchestrates the full org setup, calling other flows and tasks in a specific order.

flows:
  prepare_rlm_org:
    group: Revenue Lifecycle Management
    steps:
      1:
        flow: prepare_core
      2:
        flow: prepare_decision_tables
      3:
        flow: prepare_expression_sets
      4:
        task: create_partner_central
        when: project_config.project__custom__prm
      5:
        task: create_payments_webhook
        when: project_config.project__custom__payments
      6:
        task: deploy_full
      7:
        flow: prepare_price_adjustment_schedules
      8:
        flow: prepare_scratch
      9:
        flow: prepare_payments
      10:
        flow: prepare_quantumbit
      11:
        flow: prepare_product_data
      12:
        flow: prepare_pricing_data
      13:
        flow: prepare_docgen
      14:
        flow: prepare_dro
      15:
        flow: prepare_tax
      16:
        flow: prepare_billing
      17:
        flow: prepare_clm
      18:
        flow: prepare_rating
      19:
        task: activate_and_deploy_expression_sets
      20:
        flow: prepare_tso
      21:
        flow: prepare_procedureplans
      22:
        flow: prepare_prm
      23:
        flow: prepare_agents
      24:
        flow: prepare_constraints
      25:
        flow: prepare_guidedselling
      26:
        flow: prepare_visualization
      27:
        task: configure_revenue_settings
      28:
        task: reconfigure_pricing_discovery
        when: org_config.scratch and not project_config.project__custom__tso
      29:
        flow: refresh_all_decision_tables
         
  prepare_core:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: validate_setup
      2:
        task: assign_permission_set_licenses
        options:
          api_names: *rlm_psl_api_names
      3:
        task: cleanup_settings_for_dev
        when: org_config.scratch
      4:
        task: exclude_active_decision_tables
        when: org_config.scratch
      5:
        task: deploy_pre
      6:
        task: restore_decision_tables
        when: org_config.scratch
      7:
        task: assign_permission_set_licenses
        when: project_config.project__custom__clm
        options:
          api_names: *rlm_clm_psl_api_names
      8:
        task: assign_permission_set_licenses
        when: project_config.project__custom__einstein
        options:
          api_names: *rlm_ai_psl_api_names  
      9:
        task: util_sleep
        options:
          seconds: *sleep_default
      10:
        task: assign_permission_set_licenses
        options:
          api_names: EinsteinAnalyticsPlusPsl
      11:
        task: recalculate_permission_set_groups
        options:
          api_names: *rlm_psg_api_names
      12:
        task: assign_permission_set_groups_tolerant
        options:
          api_names: *rlm_psg_api_names
      13:
        task: assign_permission_sets
        when: project_config.project__custom__tso and project_config.project__custom__psg_debug
        options:
          api_names: *rlm_pcm_ps_api_names
      14:
        flow: extend_context_definitions
      15:
        task: util_sleep
        options:
          seconds: *sleep_default
      16:
        task: create_rule_library
        when: project_config.project__custom__breconfig
      17:
        task: util_sleep
        when: project_config.project__custom__breconfig
        options:
          seconds: *sleep_default
      18:
        task: create_dro_rule_library
        when: project_config.project__custom__dro and project_config.project__custom__breconfig
      19:
        task: assign_permission_sets
        when: project_config.project__custom__einstein
        options:
          api_names: *rlm_ai_ps_api_names
      20:
        task: assign_permission_sets
        when: project_config.project__custom__billing and project_config.project__custom__psg_debug
        options:
          api_names: *rlm_blng_ps_api_names

  extend_context_definitions:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: extend_context_sales_transaction
      2:
        task: extend_context_product_discovery
      3:
        task: extend_context_cart
        when: project_config.project__custom__commerce
      4:
        task: extend_context_billing
        when: project_config.project__custom__billing
      5:
        task: extend_context_collection_plan_segment
        when: project_config.project__custom__billing
      6:
        task: extend_context_fulfillment_asset
        when: project_config.project__custom__dro
      7:
        task: extend_context_contracts
        when: project_config.project__custom__clm
      8:
        task: extend_context_contracts_extraction
        when: project_config.project__custom__clm
      9:
        task: extend_context_rate_management
        when: project_config.project__custom__rating
      10:
        task: extend_context_rating_discovery
        when: project_config.project__custom__rating
      11:
        task: extend_context_asset

  prepare_expression_sets:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: deactivate_expression_sets
      2:
        task: ensure_pricing_schedules
        when: org_config.scratch
      3:
        task: deploy_expression_sets
        when: org_config.scratch
  
  prepare_product_data:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: insert_quantumbit_pcm_data
        when: project_config.project__custom__qb
      2:
        task: insert_q3_data
        when: project_config.project__custom__q3
      3:
        task: insert_quantumbit_product_image_data
        when: project_config.project__custom__qb

  prepare_pricing_data:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: insert_quantumbit_pricing_data
        when: project_config.project__custom__qb

  prepare_scratch:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: insert_scratch_data
        when: org_config.scratch and not project_config.project__custom__tso

  prepare_quantumbit:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: deploy_post_utils
        when: project_config.project__custom__quantumbit
      2:
        task: deploy_post_billing
        when: project_config.project__custom__quantumbit and project_config.project__custom__billing
      3:
        task: deploy_post_approvals
        when: project_config.project__custom__quantumbit and project_config.project__custom__approvals
      4:
        task: deploy_quantumbit
        when: project_config.project__custom__quantumbit
      5:
        task: assign_permission_sets
        when: project_config.project__custom__quantumbit
        options:
          api_names: *ps_quantumbit
      6:
        task: assign_permission_sets
        when: project_config.project__custom__quantumbit and project_config.project__custom__calmdelete
        options:
          api_names: *ps_calmdelete

  prepare_tso:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: assign_permission_set_licenses
        when: project_config.project__custom__tso
        options:
          api_names: *rlm_tso_psl_api_names
      2:
        task: assign_permission_set_groups
        when: project_config.project__custom__tso
        options:
          api_names: *rlm_tso_psg_api_names
      3:
        task: deploy_post_utils
        when: project_config.project__custom__tso
      4:
        task: deploy_post_tso
        when: project_config.project__custom__tso
      5:
        task: assign_permission_sets
        when: project_config.project__custom__tso
        options:
          api_names: *rlm_tso_ps_api_names
      6:
        task: assign_permission_set_groups_tolerant
        when: project_config.project__custom__tso
        options:
          api_names: *psg_tso

  prepare_dro:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: insert_qb_dro_data
        when: project_config.project__custom__dro and project_config.project__custom__qb
      2:
        task: insert_q3_dro_data_scratch
        when: org_config.scratch and project_config.project__custom__dro and project_config.project__custom__q3
      3:
        task: insert_q3_dro_data_prod
        when: not org_config.scratch and project_config.project__custom__dro and project_config.project__custom__q3

  prepare_clm:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: insert_clm_data
        when: project_config.project__custom__clm and project_config.project__custom__clm_data

  prepare_docgen:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: create_docgen_library
        when: project_config.project__custom__docgen
      2:
        task: enable_document_builder_toggle
        when: project_config.project__custom__docgen
      3:
        task: deploy_post_docgen
        when: project_config.project__custom__docgen

  prepare_billing:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: insert_billing_data
        when: project_config.project__custom__billing and not project_config.project__custom__refresh and project_config.project__custom__qb
      2:
        task: insert_q3_billing_data
        when: project_config.project__custom__billing and not project_config.project__custom__refresh and project_config.project__custom__q3
      3:
        task: activate_flow
        when: project_config.project__custom__billing
        options:
          developer_names: RLM_Order_to_Billing_Schedule_Flow
      4:
        task: activate_default_payment_term
        when: project_config.project__custom__billing
      5:
        task: activate_billing_records
        when: project_config.project__custom__billing
      6:
        task: deploy_post_billing
        when: project_config.project__custom__billing
      7:
        task: deploy_billing_id_settings
        when: project_config.project__custom__billing
      8:
        task: deploy_billing_template_settings
        when: project_config.project__custom__billing

  prepare_prm:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: deploy_post_prm
        when: project_config.project__custom__prm and project_config.project__custom__prm_exp_bundle
      2:
        task: publish_community
        when: project_config.project__custom__prm
        options:
          name: rlm
      3:
        task: deploy_sharing_rules
        when: project_config.project__custom__prm and project_config.project__custom__sharingsettings

  prepare_tax:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: create_tax_engine
        when: project_config.project__custom__tax
      2:
        task: insert_tax_data
        when: project_config.project__custom__tax and not project_config.project__custom__refresh and project_config.project__custom__qb
      3:
        task: insert_q3_tax_data
        when: project_config.project__custom__tax and not project_config.project__custom__refresh and project_config.project__custom__q3
      4:
        task: activate_tax_records
        when: project_config.project__custom__tax

  prepare_rating:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: insert_qb_rating_data
        when: project_config.project__custom__rating and not project_config.project__custom__refresh and project_config.project__custom__qb
      2:
        task: insert_q3_rating_data
        when: project_config.project__custom__rating and not project_config.project__custom__refresh and project_config.project__custom__q3
      3:
        task: insert_qb_rates_data
        when: project_config.project__custom__rating and project_config.project__custom__rates and not project_config.project__custom__refresh and project_config.project__custom__qb
      4:
        task: insert_q3_rates_data
        when: project_config.project__custom__rating and project_config.project__custom__rates and not project_config.project__custom__refresh and project_config.project__custom__q3
      5:
        task: activate_rating_records
        when: project_config.project__custom__rating and project_config.project__custom__rates
      6:
        task: activate_rates
        when: project_config.project__custom__rating and project_config.project__custom__rates

  extract_rating:
    group: Revenue Lifecycle Management
    description: Extract rating and rates data from an org into CSV files
    steps:
      1:
        task: extract_qb_rating_data
      2:
        task: extract_qb_rates_data
  
  prepare_agents:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: assign_permission_set_groups
        when: project_config.project__custom__agents
        options:
          api_names: *rlm_ai_psg_api_names
      2:
        task: deploy_agents_settings
        when: project_config.project__custom__agents
      3:
        task: deploy_agents
        when: project_config.project__custom__agents
      4:
        task: assign_permission_sets
        when: project_config.project__custom__agents
        options:
          api_names: *ps_aea
  
  refresh_all_decision_tables:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: sync_pricing_data
      2:
        task: refresh_dt_pricing_discovery
      3:
        task: refresh_dt_asset
        when: project_config.project__custom__rating
      4:
        task: refresh_dt_rating
        when: project_config.project__custom__rating
      5:
        task: refresh_dt_rating_discovery
        when: project_config.project__custom__rating
      6:
        task: refresh_dt_commerce
        when: project_config.project__custom__commerce

  prepare_decision_tables:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: activate_decision_tables
        when: org_config.scratch

  prepare_price_adjustment_schedules:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: activate_price_adjustment_schedules
        when: org_config.scratch

  prepare_procedureplans:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: deploy_post_procedureplans
        when: project_config.project__custom__procedureplans
      2:
        task: activate_procedure_plan_expression_sets
        when: project_config.project__custom__procedureplans
      3:
        task: create_procedure_plan_definition
        when: project_config.project__custom__procedureplans
      4:
        task: insert_procedure_plan_data
        when: project_config.project__custom__procedureplans
      5:
        task: activate_procedure_plan_version
        when: project_config.project__custom__procedureplans

  prepare_constraints:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: insert_qb_transactionprocessingtypes_data
        when: project_config.project__custom__constraints and project_config.project__custom__qb
      2:
        task: deploy_post_constraints
        when: project_config.project__custom__constraints
      3:
        task: assign_permission_sets
        when: project_config.project__custom__tso and project_config.project__custom__constraints
        options:
          api_names: *ps_constraints
      4:
        task: apply_context_constraint_engine_node_status
        when: project_config.project__custom__constraints
      5:
        task: enable_constraints_settings
        when: project_config.project__custom__constraints_data
      6:
        task: validate_cml
        when: project_config.project__custom__constraints_data and project_config.project__custom__qb
        options:
          cml_dir: scripts/cml
          data_dir: *quantumbit_constraints_data_dir
      7:
        task: import_cml
        when: project_config.project__custom__constraints_data and project_config.project__custom__qb
        options:
          data_dir: *quantumbit_constraints_data_dir
          dataset_dirs: "datasets/sfdmu/qb/en-US/qb-pcm"
      8:
        task: import_cml
        when: project_config.project__custom__constraints_data and project_config.project__custom__qb
        options:
          data_dir: *server2_constraints_data_dir
          dataset_dirs: "datasets/sfdmu/qb/en-US/qb-pcm"
      9:
        task: manage_expression_sets
        when: project_config.project__custom__constraints_data and project_config.project__custom__qb
        options:
          operation: activate_versions
          version_full_names: "QuantumBitComplete_V1,Server2_V1"

  prepare_guidedselling:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: insert_qb_guidedselling_data
        when: project_config.project__custom__guidedselling and project_config.project__custom__qb
      2:
        task: deploy_post_guidedselling
        when: project_config.project__custom__guidedselling

  prepare_visualization:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: deploy_post_visualization
        when: project_config.project__custom__visualization

  prepare_payments:
    group: Revenue Lifecycle Management
    steps:
      1:
        task: deploy_post_payments_site
        when: project_config.project__custom__payments
      2:
        task: publish_community
        when: project_config.project__custom__payments
        options:
          name: Payments Webhook
      3:
        task: deploy_post_payments_settings
        when: project_config.project__custom__payments

  run_qb_extracts:
    group: Data Management - Extract
    description: Run all QB data extract tasks (org  CSV). Use --org to specify source org.
    steps:
      1:
        task: extract_qb_pcm_data
      2:
        task: extract_qb_pricing_data
      3:
        task: extract_qb_product_images_data
      4:
        task: extract_qb_dro_data
      5:
        task: extract_qb_clm_data
      6:
        task: extract_qb_rating_data
      7:
        task: extract_qb_rates_data
      8:
        task: extract_qb_transactionprocessingtypes_data
      9:
        task: extract_qb_guidedselling_data

  run_qb_idempotency_tests:
    group: Data Management - Idempotency
    description: Run all QB data idempotency tests (load twice, assert no new records). Use --org to specify target org.
    steps:
      1:
        task: test_qb_pcm_idempotency
      2:
        task: test_qb_pricing_idempotency
      3:
        task: test_qb_product_images_idempotency
      4:
        task: test_qb_dro_idempotency
      5:
        task: test_qb_clm_idempotency
      6:
        task: test_qb_rating_idempotency
      7:
        task: test_qb_rates_idempotency
      8:
        task: test_qb_transactionprocessingtypes_idempotency
      9:
        task: test_qb_guidedselling_idempotency
